<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager - AI Agents Tools</title>
    <link rel="stylesheet" href="/templates/file_manager.css">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
        <span class="theme-icon">üåì</span>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üóÇÔ∏è File Manager</h1>
            <p>View and manage files uploaded to the system</p>
        </div>
        
        <div class="stats" id="stats">
            <!-- Statistics will be loaded here -->
        </div>
        
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb" class="breadcrumb">
            <span class="breadcrumb-item active" onclick="navigateToFolder('')">üè† Home</span>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <select id="typeFilter">
                <option value="">All Types</option>
                <option value="image">Images</option>
                <option value="video">Videos</option>
                <option value="audio">Audio</option>
            </select>
            
            <button class="btn btn-primary" onclick="loadCombinedView()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="toggleCreateFolderForm()">üìÅ New Folder</button>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì§ Upload Files</button>
            
            <!-- Multi-selection controls -->
            <div class="selection-controls" id="selectionControls" style="display: none;">
                <span id="selectionCount">0 selected</span>
                <button class="btn btn-secondary" onclick="selectAll()">üìã Select All</button>
                <button class="btn btn-secondary" onclick="clearSelection()">‚ùå Clear</button>
                <button class="btn btn-danger" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
            </div>
            
            <!-- Hidden file input -->
            <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,video/*,audio/*" onchange="handleFileUpload(event)">
        </div>
        
        <!-- Create Folder Form -->
        <div id="createFolderForm" class="create-folder-form">
            <h3>üìÅ Create New Folder</h3>
            <div class="form-row">
                <input type="text" id="folderNameInput" class="form-input" placeholder="Enter folder name" maxlength="50">
                <button class="btn btn-primary" onclick="createFolder()">Create</button>
                <button class="btn btn-secondary" onclick="toggleCreateFolderForm()">Cancel</button>
            </div>
        </div>
        
        <!-- Upload progress area -->
        <div id="uploadProgress" class="upload-progress">
            <h3>üì§ Upload in Progress</h3>
            <div id="uploadList"></div>
        </div>
        
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading files...</p>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">File Preview</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-info" id="modalInfo">
                <!-- File info will be loaded here -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="modalDownload">‚¨áÔ∏è Download</button>
                <button class="btn btn-secondary" id="modalCopyId">üìã Copy ID</button>
                <button class="btn btn-danger" id="modalDelete">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text">
                File Manager delivered by 
                <a href="https://www.skool.com/@darlan-benites-1638" target="_blank" class="footer-link">@darlan-benites-1638</a> 
                for 
                <a href="https://github.com/gyoridavid/ai-agents-no-code-tools" target="_blank" class="footer-link">AI Agents A-Z No-Code Tools</a> 
                open-source GitHub project from 
                <a href="https://www.skool.com/ai-agents-az" target="_blank" class="footer-link">AI Agents A-Z Community</a>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = '/api/v1/media';
        
        // Global variables for upload
        let uploadQueue = [];
        let isUploading = false;
        
        // Global variables for folder system
        let currentFolder = '';
        
        // Global variables for multi-selection
        let selectedFiles = new Set();
        let isMultiSelectMode = false;
        
        // ==================== NAVIGATION FUNCTIONS ====================
        
        function navigateToFolder(folderPath, updateHistory = true) {
            currentFolder = folderPath;
            
            // Update browser history
            if (updateHistory) {
                const url = folderPath ? `?folder=${encodeURIComponent(folderPath)}` : '/';
                const title = folderPath ? `File Manager - ${folderPath}` : 'File Manager';
                history.pushState({ folder: folderPath }, title, url);
            }
            
            updateBreadcrumb(folderPath);
            loadFolderContents(folderPath);
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const folderPath = event.state ? event.state.folder : getInitialFolderFromURL();
            currentFolder = folderPath;
            updateBreadcrumb(folderPath);
            loadFolderContents(folderPath);
        });
        
        // Get initial folder from URL parameters
        function getInitialFolderFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('folder') || '';
        }
        
        function updateBreadcrumb(folderPath) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '';
            
            // Home item
            const homeItem = document.createElement('span');
            homeItem.className = folderPath === '' ? 'breadcrumb-item active' : 'breadcrumb-item';
            homeItem.innerHTML = 'üè† Home';
            homeItem.onclick = () => navigateToFolder('');
            homeItem.title = 'Go to Home folder';
            breadcrumb.appendChild(homeItem);
            
            if (folderPath) {
                const parts = folderPath.split('/');
                let currentPath = '';
                
                parts.forEach((part, index) => {
                    currentPath += (currentPath ? '/' : '') + part;
                    const thisPath = currentPath; // Capture for closure
                    
                    // Separator
                    const separator = document.createElement('span');
                    separator.className = 'breadcrumb-separator';
                    separator.innerHTML = ' / ';
                    breadcrumb.appendChild(separator);
                    
                    // Folder item
                    const item = document.createElement('span');
                    item.className = index === parts.length - 1 ? 'breadcrumb-item active' : 'breadcrumb-item';
                    item.innerHTML = part;
                    item.title = `Go to ${thisPath}`;
                    
                    // Make all breadcrumb items clickable
                    if (index < parts.length - 1) {
                        item.onclick = () => navigateToFolder(thisPath);
                    }
                    
                    breadcrumb.appendChild(item);
                });
            }
        }
        
        // ==================== END NAVIGATION FUNCTIONS ====================
        
        // ==================== THEME FUNCTIONS ====================
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            
            // Save preference to localStorage
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle button
            const toggle = document.querySelector('.theme-toggle');
            const icon = toggle.querySelector('.theme-icon');
            
            if (newTheme === 'dark') {
                icon.textContent = 'üåô';
                toggle.classList.add('active');
            } else {
                icon.textContent = '‚òÄÔ∏è';
                toggle.classList.remove('active');
            }
            
            showNotification(`üé® Switched to ${newTheme} mode`);
        }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-theme', theme);
            
            const toggle = document.querySelector('.theme-toggle');
            const icon = toggle.querySelector('.theme-icon');
            
            if (theme === 'dark') {
                icon.textContent = 'üåô';
                toggle.classList.add('active');
            } else {
                icon.textContent = '‚òÄÔ∏è';
                toggle.classList.remove('active');
            }
        }
        
        // ==================== END THEME FUNCTIONS ====================
        
        // ==================== THUMBNAIL AND PREVIEW FUNCTIONS ====================
        
        function generateFileThumbnail(file) {
            if (!file.media_id) return '';
            
            const fileUrl = `${API_BASE}/storage/${file.media_id}`;
            const mediaType = file.media_type || 'file';
            
            let thumbnailContent = '';
            let overlayContent = '';
            
            switch (mediaType) {
                case 'image':
                    thumbnailContent = `<img src="${fileUrl}" alt="${file.filename || file.name}" loading="lazy">`;
                    overlayContent = '<div class="file-thumbnail-play">üîç</div>';
                    break;
                    
                case 'video':
                    thumbnailContent = `<video src="${fileUrl}" muted preload="metadata"></video>`;
                    overlayContent = '<div class="file-thumbnail-play">‚ñ∂Ô∏è</div>';
                    break;
                    
                case 'audio':
                    thumbnailContent = '<div class="file-thumbnail-icon">üéµ</div>';
                    overlayContent = '<div class="file-thumbnail-play">‚ñ∂Ô∏è</div>';
                    break;
                    
                default:
                    thumbnailContent = '<div class="file-thumbnail-icon">üìÑ</div>';
                    overlayContent = '<div class="file-thumbnail-play">üëÅÔ∏è</div>';
            }
            
            return `
                <div class="file-thumbnail" onclick="openPreview('${file.media_id}', '${mediaType}', '${(file.filename || file.name).replace(/'/g, "\\'")}')">
                    ${thumbnailContent}
                    <div class="file-thumbnail-overlay">
                        ${overlayContent}
                    </div>
                </div>
            `;
        }
        
        function openPreview(mediaId, mediaType, filename) {
            const modal = document.getElementById('previewModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalInfo = document.getElementById('modalInfo');
            
            modalTitle.textContent = filename;
            
            // Setup action buttons
            setupModalActions(mediaId, filename);
            
            // Generate preview content
            const fileUrl = `${API_BASE}/storage/${mediaId}`;
            let previewContent = '';
            
            switch (mediaType) {
                case 'image':
                    previewContent = `<img src="${fileUrl}" alt="${filename}" class="modal-media">`;
                    break;
                    
                case 'video':
                    previewContent = `
                        <div class="modern-video-player">
                            <video controls class="modal-media" preload="metadata" controlsList="nodownload">
                                <source src="${fileUrl}" type="video/mp4">
                                <source src="${fileUrl}" type="video/webm">
                                <source src="${fileUrl}" type="video/ogg">
                                Your browser does not support the video tag.
                            </video>
                            <div class="video-info">
                                <div class="video-title">${filename}</div>
                                <div class="video-controls-custom">
                                    <button onclick="toggleFullscreen(this.closest('.modern-video-player').querySelector('video'))" class="btn btn-secondary btn-small">üîç Fullscreen</button>
                                    <button onclick="togglePictureInPicture(this.closest('.modern-video-player').querySelector('video'))" class="btn btn-secondary btn-small">üì∫ PiP</button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'audio':
                    previewContent = `
                        <div class="modern-audio-player">
                            <div class="audio-artwork">
                                <div class="audio-icon">üéµ</div>
                            </div>
                            <div class="audio-info">
                                <div class="audio-title">${filename}</div>
                                <div class="audio-details">High quality audio player</div>
                            </div>
                            <div class="audio-controls">
                                <audio controls preload="metadata" class="modern-audio">
                                    <source src="${fileUrl}" type="audio/mpeg">
                                    <source src="${fileUrl}" type="audio/wav">
                                    <source src="${fileUrl}" type="audio/ogg">
                                    <source src="${fileUrl}" type="audio/mp4">
                                    Your browser does not support the audio tag.
                                </audio>
                            </div>
                            <div class="audio-features">
                                <button onclick="downloadAudio('${fileUrl}', '${filename}')" class="btn btn-primary btn-small">‚¨áÔ∏è Download</button>
                                <button onclick="shareAudio('${fileUrl}')" class="btn btn-secondary btn-small">üì§ Share</button>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    previewContent = `
                        <div style="padding: 40px; text-align: center; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üìÑ</div>
                            <p>Preview not available for this file type</p>
                        </div>
                    `;
            }
            
            modalBody.innerHTML = previewContent;
            
            // Load file information
            loadFileInfo(mediaId);
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function setupModalActions(mediaId, filename) {
            const downloadBtn = document.getElementById('modalDownload');
            const copyBtn = document.getElementById('modalCopyId');
            const deleteBtn = document.getElementById('modalDelete');
            
            downloadBtn.onclick = () => downloadFile(mediaId);
            copyBtn.onclick = () => copyId(mediaId);
            deleteBtn.onclick = () => {
                if (confirm(`Are you sure you want to delete "${filename}"?`)) {
                    deleteFile(mediaId);
                    closeModal();
                }
            };
        }
        
        async function loadFileInfo(mediaId) {
            const modalInfo = document.getElementById('modalInfo');
            
            try {
                const response = await fetch(`${API_BASE}/storage/${mediaId}/info`);
                const fileInfo = await response.json();
                
                modalInfo.innerHTML = `
                    <div class="modal-info-item">
                        <div class="modal-info-label">File Name</div>
                        <div class="modal-info-value">${fileInfo.filename}</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">File Size</div>
                        <div class="modal-info-value">${fileInfo.size_mb} MB</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Media Type</div>
                        <div class="modal-info-value">${fileInfo.media_type.toUpperCase()}</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">File ID</div>
                        <div class="modal-info-value">${fileInfo.media_id}</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Created</div>
                        <div class="modal-info-value">${new Date(fileInfo.created_at * 1000).toLocaleString('en-US')}</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Modified</div>
                        <div class="modal-info-value">${new Date(fileInfo.modified_at * 1000).toLocaleString('en-US')}</div>
                    </div>
                `;
            } catch (error) {
                modalInfo.innerHTML = `
                    <div class="modal-info-item">
                        <div class="modal-info-label">Error</div>
                        <div class="modal-info-value">Could not load file information</div>
                    </div>
                `;
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('previewModal');
            const modalBody = document.getElementById('modalBody');
            
            // Stop any playing media
            const videos = modalBody.querySelectorAll('video');
            const audios = modalBody.querySelectorAll('audio');
            
            videos.forEach(video => {
                video.pause();
                video.currentTime = 0;
            });
            
            audios.forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                closeModal();
            }
        };
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        // ==================== END THUMBNAIL AND PREVIEW FUNCTIONS ====================
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function detectMediaType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const videoExts = ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv'];
            const audioExts = ['mp3', 'wav', 'ogg', 'aac', 'm4a', 'flac'];
            
            if (imageExts.includes(ext)) return 'image';
            if (videoExts.includes(ext)) return 'video';
            if (audioExts.includes(ext)) return 'audio';
            
            return 'image'; // fallback
        }
        
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // Add files to queue
            files.forEach(file => {
                const uploadId = Date.now() + Math.random();
                uploadQueue.push({
                    id: uploadId,
                    file: file,
                    status: 'waiting',
                    progress: 0,
                    mediaType: detectMediaType(file.name)
                });
            });
            
            // Show progress area
            document.getElementById('uploadProgress').style.display = 'block';
            updateUploadDisplay();
            
            // Start upload if not in progress
            if (!isUploading) {
                processUploadQueue();
            }
            
            // Clear input to allow selecting same files again
            event.target.value = '';
        }
        
        function updateUploadDisplay() {
            const uploadList = document.getElementById('uploadList');
            uploadList.innerHTML = '';
            
            uploadQueue.forEach(item => {
                const div = document.createElement('div');
                div.className = 'upload-item';
                div.innerHTML = `
                    <div>
                        <div>${item.file.name}</div>
                        <div class="upload-status status-${item.status}">
                            ${getStatusText(item.status)} ${item.progress > 0 ? `(${item.progress}%)` : ''}
                        </div>
                    </div>
                    <div>${(item.file.size / (1024 * 1024)).toFixed(2)} MB</div>
                `;
                uploadList.appendChild(div);
            });
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'waiting': return '‚è≥ Waiting';
                case 'uploading': return 'üì§ Uploading';
                case 'success': return '‚úÖ Completed';
                case 'error': return '‚ùå Error';
                default: return status;
            }
        }
        
        async function processUploadQueue() {
            isUploading = true;
            
            while (uploadQueue.length > 0) {
                const item = uploadQueue.find(i => i.status === 'waiting');
                if (!item) break;
                
                item.status = 'uploading';
                updateUploadDisplay();
                
                try {
                    await uploadFile(item);
                    item.status = 'success';
                    item.progress = 100;
                    showNotification(`‚úÖ ${item.file.name} uploaded successfully!`);
                } catch (error) {
                    item.status = 'error';
                    showNotification(`‚ùå Error uploading ${item.file.name}: ${error.message}`, 'error');
                }
                
                updateUploadDisplay();
            }
            
            isUploading = false;
            
            // Remove processed items after 3 seconds
            setTimeout(() => {
                uploadQueue = uploadQueue.filter(i => i.status === 'waiting' || i.status === 'uploading');
                if (uploadQueue.length === 0) {
                    document.getElementById('uploadProgress').style.display = 'none';
                }
                updateUploadDisplay();
                loadCombinedView(); // Update current view
                loadStats(); // Update statistics
            }, 3000);
        }
        
        async function uploadFile(item) {
            const formData = new FormData();
            formData.append('file', item.file);
            formData.append('media_type', item.mediaType);
            
            // Extract filename without extension for the name parameter
            const originalName = item.file.name;
            const nameWithoutExtension = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            formData.append('name', nameWithoutExtension);
            
            // Use folder-specific endpoint if we're in a folder
            const url = currentFolder ? 
                `${API_BASE}/storage/${encodeURIComponent(currentFolder)}` : 
                `${API_BASE}/storage`;
            
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Upload error');
            }
            
            const result = await response.json();
            return result;
        }
        
        // ==================== DRAG AND DROP FUNCTIONS ====================
        
        function setupDragAndDrop() {
            const content = document.getElementById('content');
            
            // Prevent default drag behaviors on the entire document
            document.addEventListener('dragenter', preventDefaults, false);
            document.addEventListener('dragover', preventDefaults, false);
            document.addEventListener('dragleave', preventDefaults, false);
            document.addEventListener('drop', preventDefaults, false);
            
            // Add drop zone styles and handlers to content area
            content.addEventListener('dragenter', handleDragEnter, false);
            content.addEventListener('dragover', handleDragOver, false);
            content.addEventListener('dragleave', handleDragLeave, false);
            content.addEventListener('drop', handleDrop, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDragEnter(e) {
            preventDefaults(e);
            const content = document.getElementById('content');
            content.classList.add('drag-over');
            
            // Show drop message
            if (!document.getElementById('dropMessage')) {
                const dropMessage = document.createElement('div');
                dropMessage.id = 'dropMessage';
                dropMessage.className = 'drop-message';
                dropMessage.innerHTML = `
                    <div class="drop-message-content">
                        <div class="drop-icon">üì§</div>
                        <div class="drop-text">Drop files here to upload${currentFolder ? ` to "${currentFolder}"` : ''}</div>
                    </div>
                `;
                content.appendChild(dropMessage);
            }
        }
        
        function handleDragOver(e) {
            preventDefaults(e);
            e.dataTransfer.dropEffect = 'copy';
        }
        
        function handleDragLeave(e) {
            preventDefaults(e);
            
            // Only remove drag-over if we're leaving the content area completely
            const content = document.getElementById('content');
            const rect = content.getBoundingClientRect();
            
            if (e.clientX < rect.left || e.clientX >= rect.right || 
                e.clientY < rect.top || e.clientY >= rect.bottom) {
                content.classList.remove('drag-over');
                
                const dropMessage = document.getElementById('dropMessage');
                if (dropMessage) {
                    dropMessage.remove();
                }
            }
        }
        
        function handleDrop(e) {
            preventDefaults(e);
            
            const content = document.getElementById('content');
            content.classList.remove('drag-over');
            
            const dropMessage = document.getElementById('dropMessage');
            if (dropMessage) {
                dropMessage.remove();
            }
            
            const files = Array.from(e.dataTransfer.files);
            
            if (files.length === 0) {
                showNotification('‚ùå No files to upload', 'error');
                return;
            }
            
            // Filter only valid media files
            const validFiles = files.filter(file => {
                const mediaType = detectMediaType(file.name);
                return ['image', 'video', 'audio'].includes(mediaType);
            });
            
            if (validFiles.length === 0) {
                showNotification('‚ùå No valid media files to upload (images, videos, audio only)', 'error');
                return;
            }
            
            if (validFiles.length !== files.length) {
                showNotification(`‚ö†Ô∏è  Only ${validFiles.length} of ${files.length} files are valid media files`, 'warning');
            }
            
            // Process the files as if they were selected via file input
            const fakeEvent = {
                target: {
                    files: validFiles,
                    value: ''
                }
            };
            
            handleFileUpload(fakeEvent);
            
            showNotification(`üì§ Starting upload of ${validFiles.length} file(s)${currentFolder ? ` to "${currentFolder}"` : ''}!`);
        }
        
        // ==================== END DRAG AND DROP FUNCTIONS ====================
        
        // ==================== COMBINED VIEW FUNCTIONS ====================
        
        function loadCombinedView() {
            loadFolderContents(currentFolder);
        }
        
        async function loadFolderContents(folderPath = '') {
            const content = document.getElementById('content');
            const typeFilter = document.getElementById('typeFilter').value;
            
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading content...</p>
                </div>
            `;
            
            try {
                // Load folders and folder files
                const folderUrl = folderPath ? 
                    `${API_BASE}/folders/${encodeURIComponent(folderPath)}/contents` : 
                    `${API_BASE}/folders/root/contents`;
                    
                const folderResponse = await fetch(folderUrl);
                
                if (!folderResponse.ok) {
                    throw new Error(`Failed to load folders: ${folderResponse.status}`);
                }
                
                const folderData = await folderResponse.json();
                
                // Load all files (for root view when no folder selected) with type filter
                let allFiles = [];
                if (!folderPath) {
                    const filesUrl = typeFilter ? 
                        `${API_BASE}/storage/list?media_type=${typeFilter}` : 
                        `${API_BASE}/storage/list`;
                    const filesResponse = await fetch(filesUrl);
                    const filesData = await filesResponse.json();
                    allFiles = filesData.files || [];
                }
                
                let contentHtml = '';
                
                // Show folders first
                if (folderData.folders && folderData.folders.length > 0) {
                    const foldersGrid = folderData.folders.map(folder => `
                        <div class="folder-card" onclick="navigateToFolder('${folder.path}')">
                            <div class="folder-icon">üìÅ</div>
                            <div class="folder-name">${folder.name}</div>
                            <div class="folder-info">
                                <div>üÜî ${folder.id}</div>
                                <div>üìä ${folder.file_count} files</div>
                                <div>üìÖ ${new Date(folder.created_at * 1000).toLocaleString('en-US')}</div>
                            </div>
                            <div class="folder-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-secondary btn-small" onclick="copyId('${folder.id}')">
                                    üìã Copy ID
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteFolder('${folder.path}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    contentHtml += `<div class="files-grid">${foldersGrid}</div>`;
                }
                
                // Show files in current folder or all files if in root
                const filesToShow = folderPath ? (folderData.files || []) : allFiles;
                
                if (filesToShow.length > 0) {
                    const filesGrid = filesToShow.map(file => `
                        <div class="file-card ${selectedFiles.has(file.media_id) ? 'selected' : ''}" data-file-id="${file.media_id}">
                            <div class="file-checkbox">
                                <input type="checkbox" 
                                       id="file-${file.media_id}" 
                                       ${selectedFiles.has(file.media_id) ? 'checked' : ''}
                                       onchange="toggleFileSelection('${file.media_id}', this.checked)"
                                       onclick="event.stopPropagation()">
                                <label for="file-${file.media_id}"></label>
                            </div>
                            ${generateFileThumbnail(file)}
                            <div class="file-type type-${file.media_type || 'file'}">${(file.media_type || 'FILE').toUpperCase()}</div>
                            <div class="file-name">${file.filename || file.name}</div>
                            <div class="file-info">
                                <div>üì¶ ${file.size_mb} MB</div>
                                <div>üìÖ ${new Date((file.created_at) * 1000).toLocaleString('en-US')}</div>
                                ${file.media_id ? `<div>üÜî ${file.media_id}</div>` : ''}
                            </div>
                            ${file.media_id ? `
                                <div class="file-actions">
                                    <button class="btn btn-primary btn-small" onclick="downloadFile('${file.media_id}')">
                                        ‚¨áÔ∏è Download
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="copyId('${file.media_id}')">
                                        üìã Copy ID
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteFile('${file.media_id}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                    
                    if (contentHtml) {
                        contentHtml += `<br><h3>üìÑ Files:</h3><div class="files-grid">${filesGrid}</div>`;
                    } else {
                        contentHtml = `<div class="files-grid">${filesGrid}</div>`;
                    }
                }
                
                if (!contentHtml) {
                    contentHtml = `
                        <div class="empty-state">
                            <h3>üìÅ Empty</h3>
                            <p>No folders or files found. Upload some files or create folders.</p>
                        </div>
                    `;
                }
                
                content.innerHTML = contentHtml;
                
            } catch (error) {
                content.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Error loading content</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function toggleCreateFolderForm() {
            const form = document.getElementById('createFolderForm');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
                document.getElementById('folderNameInput').value = '';
            } else {
                form.style.display = 'block';
                document.getElementById('folderNameInput').focus();
            }
        }
        
        async function createFolder() {
            const folderNameInput = document.getElementById('folderNameInput');
            const folderName = folderNameInput.value.trim();
            
            if (!folderName) {
                showNotification('‚ùå Please enter a folder name', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('folder_name', folderName);
                formData.append('parent_folder', currentFolder);
                
                const response = await fetch(`${API_BASE}/folders`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`‚úÖ Folder '${folderName}' created successfully!`);
                    toggleCreateFolderForm();
                    loadCombinedView();
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå ${errorData.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Error creating folder: ${error.message}`, 'error');
            }
        }
        
        async function deleteFolder(folderPath) {
            if (!confirm(`Are you sure you want to delete the folder '${folderPath}' and all its contents?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/folders/${encodeURIComponent(folderPath)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification(`üóëÔ∏è Folder '${folderPath}' deleted successfully!`);
                    loadCombinedView();
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå ${errorData.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Error deleting folder: ${error.message}`, 'error');
            }
        }
        
        // ==================== END COMBINED VIEW FUNCTIONS ====================
        
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/storage/stats`);
                const stats = await response.json();
                
                const statsContainer = document.getElementById('stats');
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_files}</div>
                        <div>Total Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_size_mb} MB</div>
                        <div>Storage Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.by_type.image?.count || 0}</div>
                        <div>Images</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.by_type.video?.count || 0}</div>
                        <div>Videos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.by_type.audio?.count || 0}</div>
                        <div>Audio</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        function downloadFile(mediaId) {
            window.open(`${API_BASE}/storage/${mediaId}`, '_blank');
        }
        
        async function copyId(mediaId) {
            try {
                await navigator.clipboard.writeText(mediaId);
                showNotification('üìã ID copied to clipboard!');
            } catch (error) {
                prompt('Copy this ID:', mediaId);
            }
        }
        
        async function deleteFile(mediaId) {
            if (!confirm(`Are you sure you want to delete ${mediaId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/storage/${mediaId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('üóëÔ∏è File deleted successfully!');
                    loadCombinedView();
                    loadStats();
                } else {
                    showNotification('‚ùå Error deleting file', 'error');
                }
            } catch (error) {
                showNotification('‚ùå Error deleting file: ' + error.message, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('typeFilter').addEventListener('change', () => {
            loadCombinedView();
        });
        
        // Add enter key support for folder creation
        document.getElementById('folderNameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                createFolder();
            }
        });
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Escape key closes modal
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        // Initialize theme
        initTheme();
        
        // Setup drag and drop
        setupDragAndDrop();
        
        // Initialize folder from URL and setup initial state
        const initialFolder = getInitialFolderFromURL();
        currentFolder = initialFolder;
        
        // Set initial browser history state
        if (initialFolder) {
            history.replaceState({ folder: initialFolder }, `File Manager - ${initialFolder}`, `?folder=${encodeURIComponent(initialFolder)}`);
        } else {
            history.replaceState({ folder: '' }, 'File Manager', '/');
        }
        
        // ==================== MULTI-SELECTION FUNCTIONS ====================
        
        function toggleFileSelection(fileId, isSelected) {
            if (isSelected) {
                selectedFiles.add(fileId);
            } else {
                selectedFiles.delete(fileId);
            }
            updateSelectionUI();
        }
        
        function updateSelectionUI() {
            const selectionControls = document.getElementById('selectionControls');
            const selectionCount = document.getElementById('selectionCount');
            
            if (selectedFiles.size > 0) {
                selectionControls.style.display = 'flex';
                selectionCount.textContent = `${selectedFiles.size} selected`;
                isMultiSelectMode = true;
            } else {
                selectionControls.style.display = 'none';
                isMultiSelectMode = false;
            }
            
            // Update visual selection on cards
            document.querySelectorAll('.file-card').forEach(card => {
                const fileId = card.dataset.fileId;
                if (selectedFiles.has(fileId)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }
        
        function selectAll() {
            const fileCards = document.querySelectorAll('.file-card[data-file-id]');
            fileCards.forEach(card => {
                const fileId = card.dataset.fileId;
                const checkbox = card.querySelector('input[type="checkbox"]');
                selectedFiles.add(fileId);
                if (checkbox) checkbox.checked = true;
            });
            updateSelectionUI();
        }
        
        function clearSelection() {
            selectedFiles.clear();
            document.querySelectorAll('.file-card input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectionUI();
        }
        
        async function deleteSelected() {
            if (selectedFiles.size === 0) {
                showNotification('‚ùå No files selected', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedFiles.size} selected file(s)?`)) {
                return;
            }
            
            const promises = Array.from(selectedFiles).map(fileId => 
                fetch(`${API_BASE}/storage/${fileId}`, { method: 'DELETE' })
            );
            
            try {
                const results = await Promise.all(promises);
                const successful = results.filter(r => r.ok).length;
                const failed = results.length - successful;
                
                if (successful > 0) {
                    showNotification(`‚úÖ ${successful} file(s) deleted successfully!`);
                }
                if (failed > 0) {
                    showNotification(`‚ùå ${failed} file(s) failed to delete`, 'error');
                }
                
                clearSelection();
                loadCombinedView();
                loadStats();
            } catch (error) {
                showNotification(`‚ùå Error deleting files: ${error.message}`, 'error');
            }
        }
        
        // ==================== END MULTI-SELECTION FUNCTIONS ====================
        
        // ==================== MODERN PLAYER FUNCTIONS ====================
        
        function toggleFullscreen(video) {
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    showNotification(`‚ùå Error enabling fullscreen: ${err.message}`, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        function togglePictureInPicture(video) {
            if (!document.pictureInPictureElement) {
                video.requestPictureInPicture().catch(err => {
                    showNotification(`‚ùå Picture-in-Picture not supported or failed: ${err.message}`, 'error');
                });
            } else {
                document.exitPictureInPicture();
            }
        }
        
        function downloadAudio(audioUrl, filename) {
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showNotification(`üì• Downloading ${filename}...`);
        }
        
        function shareAudio(audioUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Audio File',
                    url: audioUrl
                }).then(() => {
                    showNotification('üì§ Shared successfully!');
                }).catch(err => {
                    copyToClipboard(audioUrl);
                });
            } else {
                copyToClipboard(audioUrl);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('üìã URL copied to clipboard!');
            }).catch(() => {
                prompt('Copy this URL:', text);
            });
        }
        
        // ==================== END MODERN PLAYER FUNCTIONS ====================

        // Load initial data
        loadStats();
        updateBreadcrumb(currentFolder);
        loadCombinedView(); // Start with combined view
    </script>
</body>
</html> 